# copyright: 2018, The Authors

title 'Windows DNS Vulnerability audit'

control 'CVE-2020-1350' do
  impact 1.0
  title 'Windows DNS Server Remote Code Execution Vulnerability'
  desc 'A remote code execution vulnerability exists in Windows Domain Name System servers when they fail to properly handle requests. An attacker who successfully exploited the vulnerability could run arbitrary code in the context of the Local System Account. Windows servers that are configured as DNS servers are at risk from this vulnerability.'
  tag cve: 'CVE-2020-1350'
  ref 'CVE-2020-1350', url: 'https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1350'
  # Not required to add os-family check here but including for inclusion in mixed-platform profiles
  only_if { os[:family] == 'windows' && windows_feature('DNS').installed? }

  describe.one do
    describe registry_key('HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\DNS\Parameters') do
      # InSpec tests the decimal value so we'll provide it 65280d = FF00h
      its('TcpReceivePacketSize') { should eq 65280 }
    end

    describe windows_hotfix('KB4558998') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565511') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565541') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565540') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565537') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565535') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565529') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565524') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565524') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565539') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565483') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565503') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565536') do
      it { should be_installed }
    end

    describe windows_hotfix('KB4565529') do
      it { should be_installed }
    end
  end
end
